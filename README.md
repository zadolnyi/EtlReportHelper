# EtlReportHelper
Java Spring Boot приложение делает запросы к одной базе и сохраняет в другой
  - передача данных из одной базы в другую для составления отчётов

Список отчётов (SQL-запросов к исходной БД) хранится в таблице reports целевой БД. Для каждого отчёта в этой таблице хранятся SQL-запрос к исходной БД (столбец sql_source_query), имя таблицы отчёта (столбец report_table_name) в целевой БД, в которой хранятся данные отчёта (результат запроса к исходной БД).
Часть запросов к БД реализованы через JDBC, а часть через JPA-Hibernate (Spring Data JPA - JpaRepository).
Для каждого отчёта в приложении создаётся класс с описанием столбцов отчёты. Имя этого класса прописывается для отчёта в таблице reports (в столбце class_name).
Структура таблицы reports:
id	идентификатор отчёта
name	имя отчёта
description	описание отчёта
class_name	имя класса отчёта
report_table_name	имя таблицы БД, в которой хранятся данные отчёта
sql_source_query	SQL-запрос к исходной БД на основании которого формируются данные отчёта
sql_insert	SQL-запрос добавления записи отчёта в целевую БД
sql_create_table	SQL-запрос создания таблицы отчёта в целевой БД
period	периодичность запуска обновления данных отчёта (в секундах)
reset_rebuild_counter_date	дата сброса счётчика пересоздания отчёта (использование не реализовано)
rebuild_count	счётчик полного пересоздания отчёта (использование не реализовано)
recreate	флаг пересоздания отчёта - обновлять данные отчёта или каждый раз формировать заново (удаляя старые данные). Используется если SQL-запрос к исходной БД не возвращает столбец с именем Id и реализовать обновление данных отчёта проблематично.
Приложение периодически просматривает список отчётов и для каждого отчёта запускает процедуру его создания (или обновления).
Если это только что добавленный отчёт, то для него в целевой БД создаётся таблица (её имя хранится в таблице reports в столбце report_table_name). После этого выполняется запрос к исходной БД и результат сохраняется таблице отчёта (в целевой БД).
Если для отчёта задан флаг пересоздания отчёта, то имеющиеся данные в таблице отчёта удаляются и результат запроса к исходной БД сохраняется в таблице отчёта
Если в таблице отчёта записей больше чем в результате запроса к исходной БД, то производится полное переформирование отчёта (данные в таблице отчёта удаляются и результат запроса к исходной БД сохраняется в таблице отчёта)
Если в таблице отчёта нет данных, то результат запроса к исходной БД сохраняется в таблице отчёта
Если в таблице отчёта есть данные, то производится обновление данных - последовательно сравниваются списки записей из запроса и из таблицы отчёта (эти списки отсортированы по столбцу Id).
- если у объектов в этих списках совпадают значения в стобце Id, то проверяется совпадают ли эти объекты. Если объекты совпадают, то производится переход к следующей записи, а если не совпадают, то строка из запроса к исходной БД сохраняется в таблице отчёта.
- если у объектов в этих списках значения в стобце Id не совпадают, то обновление данных прекращается и производится полное переформирование отчёта (данные в таблице отчёта удаляются и результат запроса к исходной БД сохраняется в таблице отчёта)
- если после окончания обработки списка из отчёта остались данные в списке из запроса, то эти данные добавляются в таблицу отчёта.

